<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>출석 체크 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; max-width: 900px; margin: auto; background-color: #f8f9fa; }
        .status-studying { color: #198754; font-weight: bold; }
        .status-paused { color: #ffc107; font-weight: bold; }
        .status-off { color: #6c757d; }
        .penalty { color: #dc3545; font-weight: bold; }
        .table-responsive { margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div class="text-center p-3 mb-4 bg-white rounded shadow-sm">
        <h1>🚀 스터디 출석 시스템</h1>
        <h3 id="current-time" class="text-secondary fs-5"></h3>
    </div>

    <!-- 신규 사용자 출석 폼 -->
    <div class="card p-3 mb-4 shadow-sm">
        <h5 class="card-title">이름 입력 및 출석</h5>
        <form action="{{ url_for('handle_attendance') }}" method="post">
            <div class="input-group">
                <input type="text" name="username" class="form-control" placeholder="이름을 입력하여 출석하세요" required>
                <input type="hidden" name="action" value="출석">
                <button type="submit" class="btn btn-success">오늘 첫 출석</button>
            </div>
            <div class="form-text">
                오늘 처음 오셨거나, 아직 출석하지 않은 분만 사용하세요. (출석 기준: 13시)
            </div>
        </form>
    </div>

    <!-- 현황판 -->
    <h2>현재 스터디 현황</h2>
    <div class="table-responsive">
        <table class="table table-hover table-bordered bg-white shadow-sm">
            <thead class="table-light text-center">
                <tr>
                    <th>이름</th>
                    <th>상태</th>
                    <th>오늘 공부 시간</th>
                    <th>작업</th>
                </tr>
            </thead>
           <tbody class="text-center">
                {% for user in users %}
                <tr>
                    <td><strong>{{ user.username }}</strong></td>
                    <td>
                        {# 이제 today_stats를 사용합니다 #}
                        {% if user.id in today_stats %}
                            {% set status = today_stats[user.id].status %}
                            {% if status == 'studying' %}
                                <span class="status-studying">공부 중 📖</span>
                            {% elif status == 'paused' %}
                                <span class="status-paused">중단됨 ⏸️</span>
                            {% elif status == 'completed' %}
                                <span class="status-off">완료</span>
                            {% endif %}
                        {% else %}
                            <span class="status-off">자리 비움</span>
                        {% endif %}
                    </td>
                    
                    <td>
                        {# 퇴장 후에도 최종 시간을 표시하기 위한 부분 #}
                        {% if user.id in today_stats %}
                            <span class="realtime-timer" 
                                  data-initial-seconds="{{ today_stats[user.id].total_seconds }}" 
                                  data-start-timestamp="{{ today_stats[user.id].last_event_timestamp }}"
                                  data-status="{{ today_stats[user.id].status }}">
                                --:--:--
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <form action="{{ url_for('handle_attendance') }}" method="post" class="d-flex justify-content-center gap-2">
                            <input type="hidden" name="username" value="{{ user.username }}">

                            {# 사용자가 오늘 출석 기록이 있는지 확인 #}
                            {% if user.id in today_stats %}
                                {% set status = today_stats[user.id].status %}

                                {# 1. 상태에 따른 버튼 표시 (중단/재개/완료) #}
                                {% if status == 'studying' %}
                                    <button type="submit" name="action" value="중단" class="btn btn-sm btn-warning">중단</button>
                                    <button type="submit" name="action" value="퇴장" class="btn btn-sm btn-danger">퇴장</button>
                                {% elif status == 'paused' %}
                                    <button type="submit" name="action" value="재개" class="btn btn-sm btn-info">재개</button>
                                    <button type="submit" name="action" value="퇴장" class="btn btn-sm btn-danger">퇴장</button>
                                {% elif status == 'completed' %}
                                    <span class="text-muted">완료</span>
                                {% endif %}

                                {# 2. 퇴장 처리가 안 된 경우에만 '수동 퇴장' 버튼 추가 표시 #}
                                {% if today_stats[user.id].is_unclosed %}
                                    <button type="submit"
                                        formaction="{{ url_for('force_checkout', log_id=today_stats[user.id].log_id) }}"
                                        class="btn btn-sm btn-secondary"
                                        onclick="return confirm('해당 사용자를 수동으로 퇴장 처리하시겠습니까?')">
                                        수동 퇴장
                                    </button>
                            {% endif %}

                        {# 사용자가 오늘 출석 기록이 아예 없는 경우 #}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </form>
                </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center text-muted">등록된 사용자가 없습니다.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="text-muted small mt-2">
        * 출석은 하루에 한 번만 가능합니다.<br>
        * 공부 중 '중단'을 눌러 시간을 잠시 멈출 수 있으며, '재개'를 눌러 다시 시작할 수 있습니다.
    </div>

    <!-- 전체 출석 기록 -->
     <h2>전체 출석 기록</h2>
     <div class="table-responsive">
        <table class="table table-hover table-bordered bg-white shadow-sm">
            <thead class="table-light text-center">
                <tr>
                    <th>이름</th>
                    <th>출석 시간 (UTC)</th>
                    <th>퇴장 시간 (UTC)</th>
                    <th>총 공부 시간</th>
                    <th>지각 벌금</th>
                </tr>
            </thead>
            <tbody class="text-center">
                {% for record in all_records %}
                <tr>
                    <td><strong>{{ record.user.username }}</strong></td>
                    <td>{{ record.check_in_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        {% if record.check_out_time %}
                            {{ record.check_out_time.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% set hours = (record.total_study_seconds / 3600)|int %}
                        {% set minutes = ((record.total_study_seconds % 3600) / 60)|int %}
                        {{ hours }}시간 {{ minutes }}분
                    </td>
                    <td>
                        {% if record.penalty > 0 %}
                            <span class="penalty">{{ "{:,}".format(record.penalty) }}원</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted">출석 기록이 없습니다.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 실시간 시계 및 타이머 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 현재 시간 표시 함수
        const timeElement = document.getElementById('current-time');
        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Seoul' };
            timeElement.textContent = "한국 현재 시간: " + now.toLocaleString('ko-KR', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 공부 시간 실시간 타이머 함수
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        document.querySelectorAll('.realtime-timer').forEach(timer => {
            const initialSeconds = parseInt(timer.dataset.initialSeconds, 10);
            const startTimestamp = parseFloat(timer.dataset.startTimestamp);
            const status = timer.dataset.status;

            function updateTimer() {
                let totalSeconds;
                if (status === 'studying') {
                    const elapsedSeconds = (Date.now() / 1000) - startTimestamp;
                    totalSeconds = initialSeconds + elapsedSeconds;
                } else { // 'paused' 또는 'completed' 상태일 때
                    totalSeconds = initialSeconds;
                }
                timer.textContent = formatTime(totalSeconds);
            }

            if (status === 'studying') {
                setInterval(updateTimer, 1000);
            }
            updateTimer(); // 페이지 로드 시 즉시 타이머 업데이트
        });
    </script>
</body>
</html>
