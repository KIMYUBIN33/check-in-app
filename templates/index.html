<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¶œì„ ì²´í¬ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; max-width: 900px; margin: auto; background-color: #f8f9fa; }
        .status-studying { color: #198754; font-weight: bold; }
        .status-paused { color: #ffc107; font-weight: bold; }
        .status-off { color: #6c757d; }
        .penalty { color: #dc3545; font-weight: bold; }
        .table-responsive { margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div class="text-center p-3 mb-4 bg-white rounded shadow-sm">
        <h1>ğŸš€ ìŠ¤í„°ë”” ì¶œì„ ì‹œìŠ¤í…œ</h1>
        <h3 id="current-time" class="text-secondary fs-5"></h3>
    </div>

    <!-- ì‹ ê·œ ì‚¬ìš©ì ì¶œì„ í¼ -->
    <div class="card p-3 mb-4 shadow-sm">
        <h5 class="card-title">ì´ë¦„ ì…ë ¥ ë° ì¶œì„</h5>
        <form action="{{ url_for('handle_attendance') }}" method="post">
            <div class="input-group">
                <input type="text" name="username" class="form-control" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì—¬ ì¶œì„í•˜ì„¸ìš”" required>
                <input type="hidden" name="action" value="ì¶œì„">
                <button type="submit" class="btn btn-success">ì˜¤ëŠ˜ ì²« ì¶œì„</button>
            </div>
            <div class="form-text">
                ì˜¤ëŠ˜ ì²˜ìŒ ì˜¤ì…¨ê±°ë‚˜, ì•„ì§ ì¶œì„í•˜ì§€ ì•Šì€ ë¶„ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. (ì¶œì„ ê¸°ì¤€: 13ì‹œ)
            </div>
        </form>
    </div>

    <!-- í˜„í™©íŒ -->
    <h2>í˜„ì¬ ìŠ¤í„°ë”” í˜„í™©</h2>
    <div class="table-responsive">
        <table class="table table-hover table-bordered bg-white shadow-sm">
            <thead class="table-light text-center">
                <tr>
                    <th>ì´ë¦„</th>
                    <th>ìƒíƒœ</th>
                    <th>ì˜¤ëŠ˜ ê³µë¶€ ì‹œê°„</th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
           <tbody class="text-center">
                {% for user in users %}
                <tr>
                    <td><strong>{{ user.username }}</strong></td>
                    <td>
                        {# ì´ì œ today_statsë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ #}
                        {% if user.id in today_stats %}
                            {% set status = today_stats[user.id].status %}
                            {% if status == 'studying' %}
                                <span class="status-studying">ê³µë¶€ ì¤‘ ğŸ“–</span>
                            {% elif status == 'paused' %}
                                <span class="status-paused">ì¤‘ë‹¨ë¨ â¸ï¸</span>
                            {% elif status == 'completed' %}
                                <span class="status-off">ì™„ë£Œ</span>
                            {% endif %}
                        {% else %}
                            <span class="status-off">ìë¦¬ ë¹„ì›€</span>
                        {% endif %}
                    </td>
                    
                    <td>
                        {# í‡´ì¥ í›„ì—ë„ ìµœì¢… ì‹œê°„ì„ í‘œì‹œí•˜ê¸° ìœ„í•œ ë¶€ë¶„ #}
                        {% if user.id in today_stats %}
                            <span class="realtime-timer" 
                                  data-initial-seconds="{{ today_stats[user.id].total_seconds }}" 
                                  data-start-timestamp="{{ today_stats[user.id].last_event_timestamp }}"
                                  data-status="{{ today_stats[user.id].status }}">
                                --:--:--
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <form action="{{ url_for('handle_attendance') }}" method="post" class="d-flex justify-content-center gap-2">
                            <input type="hidden" name="username" value="{{ user.username }}">

                            {# ì‚¬ìš©ìê°€ ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì´ ìˆëŠ”ì§€ í™•ì¸ #}
                            {% if user.id in today_stats %}
                                {% set status = today_stats[user.id].status %}

                                {# 1. ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ í‘œì‹œ (ì¤‘ë‹¨/ì¬ê°œ/ì™„ë£Œ) #}
                                {% if status == 'studying' %}
                                    <button type="submit" name="action" value="ì¤‘ë‹¨" class="btn btn-sm btn-warning">ì¤‘ë‹¨</button>
                                    <button type="submit" name="action" value="í‡´ì¥" class="btn btn-sm btn-danger">í‡´ì¥</button>
                                {% elif status == 'paused' %}
                                    <button type="submit" name="action" value="ì¬ê°œ" class="btn btn-sm btn-info">ì¬ê°œ</button>
                                    <button type="submit" name="action" value="í‡´ì¥" class="btn btn-sm btn-danger">í‡´ì¥</button>
                                {% elif status == 'completed' %}
                                    <span class="text-muted">ì™„ë£Œ</span>
                                {% endif %}

                                {# 2. í‡´ì¥ ì²˜ë¦¬ê°€ ì•ˆ ëœ ê²½ìš°ì—ë§Œ 'ìˆ˜ë™ í‡´ì¥' ë²„íŠ¼ ì¶”ê°€ í‘œì‹œ #}
                                {% if today_stats[user.id].is_unclosed %}
                                    <button type="submit"
                                        formaction="{{ url_for('force_checkout', log_id=today_stats[user.id].log_id) }}"
                                        class="btn btn-sm btn-secondary"
                                        onclick="return confirm('í•´ë‹¹ ì‚¬ìš©ìë¥¼ ìˆ˜ë™ìœ¼ë¡œ í‡´ì¥ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                                        ìˆ˜ë™ í‡´ì¥
                                    </button>
                            {% endif %}

                        {# ì‚¬ìš©ìê°€ ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì´ ì•„ì˜ˆ ì—†ëŠ” ê²½ìš° #}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </form>
                </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center text-muted">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="text-muted small mt-2">
        * ì¶œì„ì€ í•˜ë£¨ì— í•œ ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
        * ê³µë¶€ ì¤‘ 'ì¤‘ë‹¨'ì„ ëˆŒëŸ¬ ì‹œê°„ì„ ì ì‹œ ë©ˆì¶œ ìˆ˜ ìˆìœ¼ë©°, 'ì¬ê°œ'ë¥¼ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>

    <!-- ì „ì²´ ì¶œì„ ê¸°ë¡ -->
     <h2>ì „ì²´ ì¶œì„ ê¸°ë¡</h2>
     <div class="table-responsive">
        <table class="table table-hover table-bordered bg-white shadow-sm">
            <thead class="table-light text-center">
                <tr>
                    <th>ì´ë¦„</th>
                    <th>ì¶œì„ ì‹œê°„ (UTC)</th>
                    <th>í‡´ì¥ ì‹œê°„ (UTC)</th>
                    <th>ì´ ê³µë¶€ ì‹œê°„</th>
                    <th>ì§€ê° ë²Œê¸ˆ</th>
                </tr>
            </thead>
            <tbody class="text-center">
                {% for record in all_records %}
                <tr>
                    <td><strong>{{ record.user.username }}</strong></td>
                    <td>{{ record.check_in_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        {% if record.check_out_time %}
                            {{ record.check_out_time.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% set hours = (record.total_study_seconds / 3600)|int %}
                        {% set minutes = ((record.total_study_seconds % 3600) / 60)|int %}
                        {{ hours }}ì‹œê°„ {{ minutes }}ë¶„
                    </td>
                    <td>
                        {% if record.penalty > 0 %}
                            <span class="penalty">{{ "{:,}".format(record.penalty) }}ì›</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ì‹¤ì‹œê°„ ì‹œê³„ ë° íƒ€ì´ë¨¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // í˜„ì¬ ì‹œê°„ í‘œì‹œ í•¨ìˆ˜
        const timeElement = document.getElementById('current-time');
        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Seoul' };
            timeElement.textContent = "í•œêµ­ í˜„ì¬ ì‹œê°„: " + now.toLocaleString('ko-KR', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ê³µë¶€ ì‹œê°„ ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ í•¨ìˆ˜
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        document.querySelectorAll('.realtime-timer').forEach(timer => {
            const initialSeconds = parseInt(timer.dataset.initialSeconds, 10);
            const startTimestamp = parseFloat(timer.dataset.startTimestamp);
            const status = timer.dataset.status;

            function updateTimer() {
                let totalSeconds;
                if (status === 'studying') {
                    const elapsedSeconds = (Date.now() / 1000) - startTimestamp;
                    totalSeconds = initialSeconds + elapsedSeconds;
                } else { // 'paused' ë˜ëŠ” 'completed' ìƒíƒœì¼ ë•Œ
                    totalSeconds = initialSeconds;
                }
                timer.textContent = formatTime(totalSeconds);
            }

            if (status === 'studying') {
                setInterval(updateTimer, 1000);
            }
            updateTimer(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        });
    </script>
</body>
</html>
